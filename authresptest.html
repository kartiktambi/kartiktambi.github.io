<!DOCTYPE html>
<html>
<head>
    <title>OAuth Callback</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-database-compat.js"></script>
    <script>
        var name = "NA";
        var email = "NA";
        var userid = "NA";
        var status = "pending";
        var message = "";
        
        function getQueryParams() {
            const params = {};
            const queryString = window.location.hash.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }

        function firebaseupdate(token, otp) {
            const firebaseConfig = {
                apiKey: "AIzaSyAiD834kdRX8ojanCo0hoTcxJ9hNeP-9z0",
                authDomain: "icai-msme-startupsphere-events.firebaseapp.com",
                databaseURL: "https://icai-msme-startupsphere-events-default-rtdb.firebaseio.com",
                projectId: "icai-msme-startupsphere-events",
                storageBucket: "icai-msme-startupsphere-events.appspot.com",
                messagingSenderId: "1018180720809",
                appId: "1:1018180720809:web:49d0e002cd6eb7ced071b8"
            };
            
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const updates = {
                status: status,
                name: name,
                email: email,
                userid: userid,
                accesstoken: token
            };
            
            const loginRef = database.ref('Login/' + otp);
            loginRef.update(updates, (error) => {
                if (error) {
                    //firebase update error
                    message = "Login failed due to reason - " + error + ".\nPlease return to app screen.";
                    document.getElementById("label").innerHTML = message;
                } else {
                    //complete process success
                    document.getElementById("label").innerHTML = message;
                }
            });
        }

        window.onload = function() {
            const params = getQueryParams();
            var accessToken = params['access_token'];
            var rawOTP = params['state']; //with quotes
            const loginOTP = rawOTP.substr(1,9); //without quotes
            window.history.pushState({},document.title, "/" + "authresptest.html");
            
            if (accessToken) {
                fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${accessToken}`)
                    .then(response => response.json())
                    .then(data => {
                        //google auth success
                        name = data.name;
                        email = data.email;
                        userid = data.sub;
                        status = "done";
                        message = "Successfully logged in.\nPlease return to app screen.";
                        
                        firebaseupdate(accessToken, loginOTP);
                    })
                    .catch(error => {
                        //google auth token error
                        status = "failed | " + error;
                        message = "Login failed due to Server error - " + error + ".\nPlease return to app screen.";
                        firebaseupdate(accessToken, loginOTP);
                    });
            } else {
                //google auth faield or denied
                status = "failed | " + params['error'];
                accessToken = "NA";
                message = "Login failed due to Google Authentication Error - " + params['error'] + ".\nPlease return to app screen.";
                firebaseupdate(accessToken, loginOTP);
            }
        };
    </script>
</head>
<body>
    <h1 id="label">Processing & Logging you in...</h1>
    <!--<h2 id="subtitle">Please do not close this page.</h1>-->
</body>
</html>
