<!DOCTYPE html>
<html>
<head>
    <title>OAuth Callback</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-database-compat.js"></script>
    <script>
        var name = "NA";
        var email = "NA";
        var userid = "NA";
        var status = "pending";
        var message = "";
        
        function getQueryParams() {
            const params = {};
            const queryString = window.location.hash.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }

        function firebaseupdate(otp) {
            const firebaseConfig = {
                apiKey: "AIzaSyAiD834kdRX8ojanCo0hoTcxJ9hNeP-9z0",
                authDomain: "icai-msme-startupsphere-events.firebaseapp.com",
                databaseURL: "https://icai-msme-startupsphere-events-default-rtdb.firebaseio.com",
                projectId: "icai-msme-startupsphere-events",
                storageBucket: "icai-msme-startupsphere-events.appspot.com",
                messagingSenderId: "1018180720809",
                appId: "1:1018180720809:web:49d0e002cd6eb7ced071b8"
            };
            
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const updates = {
                status: status,
                name: name,
                email: email,
                userid: userid
            };
            
            const loginRef = database.ref('Login/' + otp);
            loginRef.update(updates, (error) => {
                if (error) {
                    console.error(error);
                    //alert('Update failed' + error);
                    message = "Login failed due to reason - " + error + ".\nPlease return to app screen.";
                    document.getElementById("label").innerHTML = message;
                } else {
                    //alert('Update successful');
                    document.getElementById("label").innerHTML = message;
                }
            });
        }

        window.onload = function() {
            const params = getQueryParams();
            const accessToken = params['access_token'];
            var rawOTP = params['state']; //with quotes
            const loginOTP = rawOTP.substr(1,9); //without quotes
            window.history.pushState({},document.title, "/" + "authresptest.html");
            
            if (accessToken) {
                fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${accessToken}`)
                    .then(response => response.json())
                    .then(data => {
                        //console.log(data);
                        name = data.name;
                        email = data.email;
                        userid = data.sub;
                        status = "done";
                        message = "Successfully logged in.\nPlease return to app screen.";

                        const url = "https://oauth2.googleapis.com/revoke?token=" + accessToken;
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-type': 'application/x-www-form-urlencoded'
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                //console.log('Token revoked successfully');
                                firebaseupdate(loginOTP);
                            } else {
                                console.error('Failed to revoke token', response.status, response.statusText);
                                firebaseupdate(loginOTP);
                            }
                        })
                        .catch(error => {
                            console.error('Error revoking token', error);
                            firebaseupdate(loginOTP);
                        });
                    })
                    .catch(error => {
                        status = "failed | " + error;
                        message = "Login failed due to reason - " + error + ".\nPlease return to app screen.";
                        firebaseupdate(accessToken, loginOTP);
                    });
            } else {
                status = "failed | " + params['error'];
                message = "Login failed due to reason - " + params['error'] + ".\nPlease return to app screen.";
                firebaseupdate(accessToken, loginOTP);
            }
        };
    </script>
</head>
<body>
    <h1 id="label">Logging you in...<br>Please wait, do not close.</h1>
</body>
</html>
