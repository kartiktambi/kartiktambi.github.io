<!DOCTYPE html>
<html>
<head>
  <title>Export Bookmarks</title>
  <style>
    #response-label img {
      max-width: 500px;
      max-height: 300px;
      border-radius: 10px;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.5);
    }
  </style>
  <script>
    function doubleDecodeNumber(doubleEncodedNumber) {
      const base64Decoded = atob(doubleEncodedNumber);
      const base64DecodedAgain = atob(base64Decoded);
      const dividedNumber = parseFloat(base64DecodedAgain) / 2;
      return dividedNumber;
    }

    function cleanUpResponse(rawResponse) {
      const startIndex = rawResponse.indexOf('google.visualization.Query.setResponse(') + 'google.visualization.Query.setResponse('.length;
      const endIndex = rawResponse.lastIndexOf(');');
      const jsonResponse = rawResponse.substring(startIndex, endIndex);
      return jsonResponse;
    }

    function formatListToText(list) {
      return list.join(' OR ');
    }

    function displayExtractedValues(jsonResponse) {
      const rows = jsonResponse.table.rows;

      let extractedValues = '';

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const col1 = row.c[0].f;
        const col2 = row.c[1].v;
        const col3 = row.c[2].v;
        const col4 = row.c[3].v;
        const col5 = row.c[4].v;
        const col6 = row.c[5].v;
        const col7 = row.c[6].v;

        extractedValues += `${col1}<br>${col2}<br><img src="${col3}"><br>${col4}<br>${col5}<br>${col6}<br>${col7}<br><br>`;
      }

      // Display the extracted values in the label
      const responseLabel = document.getElementById('response-label');
      responseLabel.innerHTML = extractedValues;
    }

    function getRequest() {
      const urlParams = new URLSearchParams(window.location.search);
      const encodedNumber = urlParams.get('number');

      const decodedNumber = doubleDecodeNumber(encodedNumber);

      const requestUrl = `https://docs.google.com/spreadsheets/d/1RC_QUIUBf7juTngdPFlC73wo9w2A6HZwl4CpVO1A-ew/gviz/tq?tq=SELECT%20W%20WHERE%20D%20MATCHES%20'${decodedNumber}'`;

      fetch(requestUrl)
        .then(response => response.text())
        .then(data => {
          const cleanedResponse = cleanUpResponse(data);
          const jsonResponse = JSON.parse(cleanedResponse);

          const value = jsonResponse.table.rows[0].c[0].v;
          const items = value.split(' | ');
          const replacedItems = items.map(item => `D MATCHES '${item}'`);

          const listToText = formatListToText(replacedItems);

          const newRequestUrl = `https://docs.google.com/spreadsheets/d/1RC_QUIUBf7juTngdPFlC73wo9w2A6HZwl4CpVO1A-ew/gviz/tq?tq=SELECT%20D,G,Q,R,S,T,U%20WHERE%20${listToText}`;

          fetch(newRequestUrl)
            .then(response => response.text())
            .then(data => {
              const cleanedResponse2 = cleanUpResponse(data);
              const jsonResponse2 = JSON.parse(cleanedResponse2);
              displayExtractedValues(jsonResponse2);
            })
            .catch(error => {
              console.error('Error:', error);
            });
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }
  </script>
</head>
<body onload="getRequest()">
  <label id="response-label">Processing...</label>
</body>
</html>
