<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3CD-MRL Admin Panel (AY 2025)</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root{
      --accent:#0077cc;
      --accent-dark:#0b69a3;
      --bg:#eef6fb;
      --muted:#6b7280;
    }
    body{margin:0;font-family:"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:#1f2937;}
    .topbar{background:linear-gradient(90deg,var(--accent-dark),var(--accent));color:#fff;padding:16px 28px;font-size:20px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    .tabs{display:flex;gap:8px;padding:14px 20px;background:#fff;border-bottom:1px solid #e6eef8;}
    .tab{padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;color:var(--muted);}
    .tab.active{background:var(--accent);color:#fff;}
    .wrap{max-width:1150px;margin:20px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 4px 20px rgba(14,50,95,0.08);}
    .controls-row{display:flex;gap:10px;align-items:center;margin-bottom:10px;}
    .controls-row .btn{padding:8px 12px;border-radius:8px;border:1px solid #dbeafe;background:#eaf6ff;color:var(--accent);cursor:pointer;font-weight:600;}
    .chart-card{background:#fbfdff;padding:14px;border-radius:8px;border:1px solid #eef6fb;}
    .chart-title{font-weight:700;margin-bottom:8px;color:#0b2b4a;}
    #loadingOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.85);z-index:9999;font-size:18px;font-weight:700;color:var(--accent);}
    .field{margin-top:12px;}
    label{display:block;font-weight:700;color:#0b2b4a;margin-bottom:6px;}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1e7fb;font-size:15px;}
    textarea{min-height:110px;resize:vertical;}
    .btn-primary{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700;}
    .btn-ghost{background:transparent;color:var(--accent);padding:10px 14px;border:1px solid #dbeefe;border-radius:8px;cursor:pointer;font-weight:700;}
    .charts{display:flex;flex-direction:column;gap:18px;}
    @media(max-width:700px){.wrap{margin:10px;}}
  </style>
</head>
<body>
  <div class="topbar">3CD-MRL Admin Panel — AY 2025</div>

  <div class="tabs">
    <div id="tabSummary" class="tab active">Summary Dashboard</div>
    <div id="tabUsers" class="tab">All Users</div>
  </div>

  <div id="loadingOverlay">Loading & processing data…</div>

  <div class="wrap">
    <!-- SUMMARY -->
    <section id="summarySection">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800;font-size:18px;color:#0b2b4a;">Summary</div>
        <div class="controls-row">
          <button id="prevWindow" class="btn">Prev. 4 days</button>
          <button id="nextWindow" class="btn">Next 4 days</button>
        </div>
      </div>

      <div class="charts">
        <div class="chart-card">
          <div class="chart-title">4-Day Submissions vs Activations</div>
          <div id="fourDayChart" style="height:320px;"></div>
        </div>

        <div class="chart-card">
          <div class="chart-title">Total Summary</div>
          <div id="summaryTotals" style="margin-top:10px;color:var(--muted);font-weight:700;"></div>
          <div id="pieChart" style="height:320px;"></div>
        </div>
      </div>
    </section>

    <!-- USERS -->
    <section id="usersSection" style="display:none;">
      <div style="font-weight:800;font-size:18px;color:#0b2b4a;">All Users / Utility Helper</div>
      <div class="field">
        <label>Search By</label>
        <select id="searchTypeUsers">
          <option value="email">Email</option>
          <option value="mobile">Mobile</option>
        </select>
      </div>

      <div class="field">
        <label>Enter Value</label>
        <input id="searchValueUsers" placeholder="Type email or mobile number" />
        <div style="margin-top:8px;">
          <button id="fetchBtn" class="btn-primary">Fetch Details</button>
        </div>
      </div>

      <div class="field"><label>Activation Key (A)</label><input id="codeBox" readonly /></div>
      <div class="field"><label>Name (B)</label><input id="nameBox" readonly /></div>
      <div class="field"><label>Mobile Number (Column C):</label>
<div style="display: flex; gap: 8px; align-items: center;">
  <input type="text" id="mobileBox" readonly style="flex: 1;">
  <button id="whatsappBtn" style="flex-shrink: 0; background: #25D366; color: white; padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer;">
    📱 WhatsApp
  </button>
</div>
</div>
      
      <div class="field"><label>Email (D)</label><input id="emailBox" readonly /></div>
      <!--<div class="field"><label>Config File (editable)</label><textarea id="colOBox"></textarea></div>-->

      <div style="margin-top:10px;">
        <button id="makeEmailBtn" class="btn-ghost">Give Email Body</button>
        <button id="downloadBtn" class="btn-primary" style="display: none">Download Config (ZIP)</button>
      </div>

      <div class="field"><label>Email Body</label><textarea id="emailBody" readonly></textarea></div>
    </section>
  </div>

  <script>
  google.charts.load("current",{packages:["corechart","bar"]});
  google.charts.setOnLoadCallback(init);

  const sheetURL = "https://docs.google.com/spreadsheets/d/1Uj1_IbrzA8TgaBHC0KRVE1m3MDxdGPhARBYHoY6-Pdg/gviz/tq?sheet=Sheet1&tq=" + encodeURIComponent("select * where K=2025");

  let allData = {}, sortedDates=[], windowStart=0;

  const showLoading=()=>document.getElementById("loadingOverlay").style.display="flex";
  const hideLoading=()=>document.getElementById("loadingOverlay").style.display="none";

  function fixDateOffset(dateValue){
    const d = new Date(dateValue);
    d.setHours(d.getHours() + 12); // fixes UTC shift (adds half a day buffer)
    return d.toISOString().split("T")[0];
  }

  function init(){loadSummary();}

  function loadSummary(){
    showLoading();
    const q=new google.visualization.Query(sheetURL);
    q.send(r=>{
      hideLoading();
      if(r.isError()){alert("Error:"+r.getMessage());return;}
      const t=r.getDataTable();const rows=t.getNumberOfRows();
      const map={};let totalSub=0,totalAct=0;
      for(let i=0;i<rows;i++){
        const dateV=fixDateOffset(t.getValue(i,8));
        if(!dateV)continue;
        totalSub++;
        if(!map[dateV])map[dateV]={sub:0,act:0};
        map[dateV].sub++;
        const raw=t.getValue(i,11);const fmt=t.getFormattedValue(i,11);
        const active=!((fmt&&fmt.trim()==="0")||raw===0);
        if(active){map[dateV].act++;totalAct++;}
      }
      allData=map;
      sortedDates=Object.keys(map).sort((a,b)=>b.localeCompare(a));
      windowStart=0;
      drawCharts(totalSub,totalAct);
    });
  }

  function drawCharts(totalSub,totalAct){
    drawFourDay();
    drawPie(totalSub,totalAct);
  }

  function drawFourDay(){
    const data=new google.visualization.DataTable();
    data.addColumn("string","Date");
    data.addColumn("number","Submissions");
    data.addColumn({type:"string", role:"annotation"});
    data.addColumn("number","Activations");
    data.addColumn({type:"string", role:"annotation"});

    const slice=sortedDates.slice(windowStart,windowStart+4);
    for(const d of slice){
      const obj=allData[d];
      data.addRow([d,obj.sub,String(obj.sub),obj.act,String(obj.act)]);
    }

    const options={
      height:320,
      legend:{position:"bottom"},
      colors:["#2196f3","#43a047"],
      bar:{groupWidth:"60%"},
      annotations:{alwaysOutside:true,textStyle:{fontSize:13,color:"#000"}},
      chartArea:{left:40,top:20,width:"85%",height:"70%"}
    };
    new google.visualization.ColumnChart(document.getElementById("fourDayChart")).draw(data,options);
  }

  function drawPie(totalSub,totalAct){
    const data=google.visualization.arrayToDataTable([
      ["Status","Count"],
      ["Activated",totalAct],
      ["Not Activated",Math.max(0,totalSub-totalAct)]
    ]);
    const options = {
  pieSliceText: "value",
  legend: { position: "bottom" },
  slices: {
    0: { color: "#43a047" }, // Activated - green
    1: { color: "#e53935" }  // Not activated - red
  },
  chartArea: { width: "90%", height: "80%" },
  pieSliceTextStyle: {
    fontSize: 18,     // ← Increase this number for bigger text
    bold: true,       // optional
    color: "#000000"  // optional - text color
  }
};

    new google.visualization.PieChart(document.getElementById("pieChart")).draw(data,options);
    document.getElementById("summaryTotals").textContent=`Submissions: ${totalSub} · Activated: ${totalAct}`;
  }

  document.getElementById("prevWindow").onclick=()=>{
    if(windowStart+4<sortedDates.length){windowStart+=4;drawFourDay();}
    else alert("No earlier data.");
  };
  document.getElementById("nextWindow").onclick=()=>{
    if(windowStart-4>=0){windowStart-=4;drawFourDay();}
    else alert("Already latest 4 days.");
  };

// ✅ Send WhatsApp button handler
document.getElementById("whatsappBtn").onclick = () => {
  const mobile = document.getElementById("mobileBox").value.trim();
  if (!mobile) {
    alert("No mobile number available.");
    return;
  }

  // Format to WhatsApp international link (assumes Indian numbers if not prefixed)
  let phone = mobile.replace(/\D/g, ""); // remove non-digits
  if (phone.startsWith("0")) phone = "91" + phone.slice(1);
  else if (!phone.startsWith("91")) phone = "91" + phone;

  const message = encodeURIComponent(
    "Namaste Ji,\nThis is CA Lalit Tambi from 3CD MRL Utility."
  );
  const whatsappURL = `https://wa.me/${phone}?text=${message}`;
  window.open(whatsappURL, "_blank");
};


  // Tabs
  document.getElementById("tabSummary").onclick=()=>{
    document.getElementById("summarySection").style.display="";
    document.getElementById("usersSection").style.display="none";
    document.getElementById("tabSummary").classList.add("active");
    document.getElementById("tabUsers").classList.remove("active");
  };
  document.getElementById("tabUsers").onclick=()=>{
    document.getElementById("summarySection").style.display="none";
    document.getElementById("usersSection").style.display="";
    document.getElementById("tabUsers").classList.add("active");
    document.getElementById("tabSummary").classList.remove("active");
  };

  // Fetch User Info
  document.getElementById("fetchBtn").onclick=()=>{
    const val=document.getElementById("searchValueUsers").value.trim().toLowerCase();
    if(!val)return alert("Enter search value");
    showLoading();
    const q=new google.visualization.Query(sheetURL);
    q.send(r=>{
      hideLoading();
      if(r.isError()){alert("Error:"+r.getMessage());return;}
      const t=r.getDataTable(),rows=t.getNumberOfRows();
      let found=false;
      for(let i=0;i<rows;i++){
        const mobile=(t.getValue(i,2)||"").toString().toLowerCase();
        const email=(t.getValue(i,3)||"").toString().toLowerCase();
        if(val===mobile||val===email){
          found=true;
          document.getElementById("codeBox").value=t.getValue(i,0)||"";
          document.getElementById("nameBox").value=t.getValue(i,1)||"";
          document.getElementById("mobileBox").value=t.getValue(i,2)||"";
          document.getElementById("emailBox").value=t.getValue(i,3)||"";
          const colO=t.getValue(i,14);
          if(colO){document.getElementById("colOBox").value=colO;}
          break;
        }
      }
      if(!found)alert("Not found");
    });
  };

  // Restore proper email body
  document.getElementById("makeEmailBtn").onclick = () => {
  const name = document.getElementById("nameBox").value.trim();
  const code = document.getElementById("codeBox").value.trim();
  const mobile = document.getElementById("mobileBox").value.trim();
  if (!name || !code) return alert("Please fetch details first.");

  const body = `Respected ${name} Ji,

Warm greetings.

It is my privilege to share with you the latest version of the 3CD-MRL Utility for Assessment Year 2025-26. Please find below your personalized activation details:

— ACTIVATION CODE —
${code}

User Name : ${name}
Registered Mobile : ${mobile}
Valid for Assessment Year : 2025-26

You may kindly download the Utility (.xlsm file) from the following secure link:

https://dl.dropboxusercontent.com/s/e6zr3uhylav70ud6dso5g/3CD-MRL-Utility_AY2526_v2-1.xlsm?rlkey=o4yeva8vevkikvxq7bqazwzfs&st=ayitp6a4

After downloading, please open the file and click on the “Activate Utility” button (on the Instructions sheet). Paste your Activation Code when prompted to enable immediate access.

I sincerely hope that this self-developed Utility proves valuable in your professional work. Your esteemed feedback and continued encouragement have been instrumental in refining and enhancing this tool for our fraternity.

In case of any difficulty or suggestions, please write to me at lalittambi@live.com or WhatsApp me on 8983322027. I shall be honoured to assist personally.

With warm regards and professional respect,

CA Lalit Tambi
Kartik L. Tambi
`;

  document.getElementById("emailBody").value = body;
};


  // Download Config
  document.getElementById("downloadBtn").onclick = async () => {
  const configText = document.getElementById("colOBox").value;
  const name = document.getElementById("nameBox").value.trim() || "Config";
  if (!configText.trim()) return alert("No config data to download.");

  const zip = new JSZip();
  const folder = zip.folder("3CD-MRL Utility 2025");

  // File 1: personalized config
  folder.file(`${name}.txt`, configText);

  // File 2: reference config name
  folder.file("mrlconfig.txt", `${name}\n`);

  const blob = await zip.generateAsync({ type: "blob" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${name}.zip`;
  a.click();
  URL.revokeObjectURL(a.href);
};

  </script>
</body>
</html>
